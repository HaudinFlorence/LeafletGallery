<html>
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaflet tile maps</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/js/all.min.js"></script>

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>


</head>
<body>


<script>
// Function to get data from a .json file
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.responseType = "json";
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
};

function getBaseMapName(data){
  name=data["name"]
  if (name.includes(".")){
   var basemap=name.split(".")[0];
  }
  else{
    var basemap=name
  }
  return basemap
}

function initMap(data,accessData){
  basemap=getBaseMapName(data);
  var MapContainer = document.createElement("div"); 
  MapContainer.style.width="80%"
  MapContainer.style.height="30%"
  MapContainer.className = "map-container";
	document.body.append(MapContainer);   
  key=Object.keys(data);
  val=Object.values(data);
  nbOfRows=Object.keys(data).length;
  const body = document.body;

 try{
    var parisMap = L.map(MapContainer, {attributionControl: true} ).setView([48.81646, 2.46912], 11); 
    	//var marker = L.marker([48.81646, 2.46912]).addTo(parisMap);;
      //---------------------------------------------------------------------------------------------------------------------
      if (accessData[basemap]===undefined){ // No apikey or access token needed
        L.tileLayer(data["url"],data).addTo(parisMap);
        tbl1 = document.createElement("table");
        tbl1.className = "table-container";

        for (let i = 0; i < nbOfRows; i++) {
          const tr1 = tbl1.insertRow();
          for (let j = 0; j < 2; j++) {
            if (i === nbOfRows-2 && j === 2) {
              break;
            } 
            else {
             const td1 = tr1.insertCell();
             if(j==0){// First column of the table : the one with the keys
               td1.appendChild(document.createTextNode(key[i]));
               td1.className="key-cell";
              }
            else{// Second column of the table : the one with the values of the metadata
              td1.className="val-cell"
              td1.appendChild(document.createTextNode(val[i]));
            }
          }
        }
      }
      body.appendChild(tbl1);
    }
    //---------------------------------------------------------------------------------------------------------------------
	    else{ // You need to give an apikey or an access token to display the map
        dict=accessData[basemap];
        var accessString=dict["accessString"]; 
        tbl3 = document.createElement("table");
        tbl3.className = "table-container";
        for (let i = 0; i < nbOfRows; i++) {
            const tr3 = tbl3.insertRow();
            for (let j = 0; j < 2; j++) {
              if (i === nbOfRows-2 && j === 2) {
                break;
              } 
              else {
              const td3 = tr3.insertCell();
              if(j==0){// First column of the table : the one with the keys
                td3.appendChild(document.createTextNode(key[i]));
                td3.className="key-cell";
              }
              else{// Second column of the table : the one with the values of the metadata
                td3.className="val-cell"
                if(key[i]===accessString){ // consider separately the case where key is the apikey or access token 
                  //create an input and a button with onclick function
                  var keyInput = document.createElement("input");
                  keyInput.type="text";
                  keyInput.value="Enter your APIkey please";
                  keyInput.className='key-container';
                  td3.append(keyInput);  
                  var validationButton = document.createElement("button");
                  validationButton.className="button-container";
                  td3.append(validationButton); 
                  validationButton.innerHTML = "validate";
                  validationButton.onclick=get_Code;
                  function get_Code(){
                    val[i]=keyInput.value;
                    data[accessString]=keyInput.value;
                    L.tileLayer(data["url"],data).addTo(parisMap);
                  }
                }
                else{
                  td3.appendChild(document.createTextNode(val[i]));
                }
              }
            }
          } 
        }  
      body.appendChild(tbl3);
      }
    }
  catch{
  }
}

function initMapTitle(data){
  var TitleDiv = document.createElement("div");
  TitleDiv.className = "title-container";
	var TitleContent = document.createTextNode(data["name"]);
	TitleDiv.appendChild(TitleContent);
	document.body.append(TitleDiv);  

}
var accessData={
"Thunderforest": {
    "accessString":"apikey",
    "name": "Thunderforest"

},
"OpenWeatherMap": {
    "accessString":"apiKey",
    "name": "OpenWeatherMap"
},

     "HERE": {
    "accessString": "app_code",
    "accessID":"app_id",
    "name": "HERE"
} ,  
        
"HEREv3":{
    "accessString": "app_code",
    "accessID":"app_id",
    "name": "HEREv3"   
  },
"MapTiler": {
"accessString": "key",
"name": "MapTiler"
  },
"MapBox": {
"accessString": "accessToken",
"name": "MapBox"
},
"Jawg":{
"accessString":"accessToken",
"name": "Jawg"
  },
"TomTom":{
"accessString": "apikey",
"name": "TomTom"
  }
}

var data1 ={
  "OpenStreetMap": {
        "Mapnik": {
            "url": "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "max_zoom": 19,
            "html_attribution": "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors",
            "attribution": "(C) OpenStreetMap contributors",
            "name": "OpenStreetMap.Mapnik"
        }
      },
  "Thunderforest": {
        "OpenCycleMap": {
            "url": "https://{s}.tile.thunderforest.com/{variant}/{z}/{x}/{y}.png?apikey={apikey}",
            "html_attribution": "&copy; <a href=\"http://www.thunderforest.com/\">Thunderforest</a>, &copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors",
            "attribution": "(C) Thunderforest, (C) OpenStreetMap contributors",
            "variant": "cycle",
            "apikey": "<insert your api key here>",
            "max_zoom": 22,
            "name": "Thunderforest.OpenCycleMap"
        }
      },
  "HERE": {
        "normalDay": {
            "url": "https://{s}.{base}.maps.api.here.com/maptile/2.1/{type}/{mapID}/{variant}/{z}/{x}/{y}/{size}/{format}?app_id={app_id}&app_code={app_code}&lg={language}",
            "html_attribution": "Map &copy; 1987-2022 <a href=\"http://developer.here.com\">HERE</a>",
            "attribution": "Map (C) 1987-2022 HERE",
            "subdomains": "1234",
            "mapID": "newest",
            "app_id": "<insert your app_id here>",
            "app_code": "<insert your app_code here>",
            "base": "base",
            "variant": "normal.day",
            "max_zoom": 20,
            "type": "maptile",
            "language": "eng",
            "format": "png8",
            "size": "256",
            "name": "HERE.normalDay"
        }
    }
  }

    
var createMapDataList=function(data){
  var outDataList=[]    
  //getJSON("https://raw.githubusercontent.com/geopandas/xyzservices/main/provider_sources/leaflet-providers-parsed.json", (err, data) => {
  
    for([keyData, valData] of Object.entries(data)) { 
	    if (valData["url"]===undefined){// check if url is a key of the json object, if not go one level deeper and define the val as the new object
		    newdata=valData;

		    for([keyNewdata, valNewdata] of Object.entries(newdata)){
			    if (valNewdata["bounds"]===undefined){
			    }
			    else{
		  	  valNewdata["bounds"]=undefined;		
			    }			
		    outDataList.push(valNewdata);	
		    }
	    }
		
	    else{
  		  outDataList.push(valData);
	    }
    }
  //})

  return outDataList
}

var dataList=createMapDataList(data=data1)
const section1 = document.createElement("section");
section1.className = "top-page";
document.body.append(section1); 
const header=document.createElement("header")
header.className = "header";
document.body.append(header); 
const div1=document.createElement("div")
div1.className = "landing-page";
document.body.append(div1); 
const h1 = document.createElement("h1");
h1.className = "big-title";
const textNode1 = document.createTextNode("Welcome to Leaflet's catalog");
h1.appendChild(textNode1);
document.body.append(h1);

for (let ii = 0; ii < dataList.length; ii++){
//for (let ii = 0; ii < 1; ii++){
  data=dataList[ii];
  //console.log('data is :',data)
  const div2 = document.createElement("div");
  div2.className = "thumbnail";
  document.body.append(div2); 
  initMapTitle(data);
  initMap(data,accessData);
}

</script>
</body>
</html>
