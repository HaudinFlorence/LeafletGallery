<html>
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaflet tile maps</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/js/all.min.js"></script>

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
   crossorigin=""></script>


</head>
<body>
<script>
  var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.responseType = "json";
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    }
    xhr.send();
}

  function getBaseMapName(data) {
  name=data["name"];
  if (name.includes(".")){
   var basemap=name.split(".")[0];
  }
  else{
    var basemap=name;
  }
  return basemap
}

var accessData={ // contains the keys for basemaps that need some identification data (apikey, access token or ID code)
  "Thunderforest": {
    "keyString":"apikey",
    "idString":"",
    "name": "Thunderforest"
  },
  "OpenWeatherMap": {
    "keyString":"apiKey",
    "idString":"",
    "name": "OpenWeatherMap"
  },
  "HERE": {
    "keyString": "app_code",
    "idString":"app_id",
    "name": "HERE"
  },        
  "HEREv3": {
    "keyString": "app_code",
    "idString":"app_id",
    "name": "HEREv3"   
  },
  "MapTiler": {
    "keyString": "key",
    "idString":"",
  "name": "MapTiler"
  },
  "MapBox": {
    "keyString": "accessToken",
    "idString":"",
    "name": "MapBox"
  },
  "Jawg": {
    "keyString":"accessToken",
    "idString":"",
    "name": "Jawg"
  },
  "TomTom": {
    "keyString": "apikey",
    "idString":"",
    "name": "TomTom"
  }
}

function initMapTitle(data) {
  var TitleDiv = document.createElement("div");
  TitleDiv.className = "title-container";
	var TitleContent = document.createTextNode(data["name"]);
	TitleDiv.appendChild(TitleContent);
	document.body.append(TitleDiv);  
}

function initMap(data,accessData) {
  basemap=getBaseMapName(data);
  var MapContainer = document.createElement("div"); 
  MapContainer.style.width="60%"
  MapContainer.style.height="20%"
  MapContainer.className = "map-container";
	document.body.append(MapContainer);   
  key=Object.keys(data);
  val=Object.values(data);
  nbOfRows=Object.keys(data).length;
  const body = document.body;

 try {
    //var parisMap = L.map(MapContainer, {attributionControl: true} ).setView([48.81646, 2.46912], 4); 
    var parisMap = L.map(MapContainer, {attributionControl: true} ).setView([50.1109, 8.6821], 12); 
    	//var marker = L.marker([48.81646, 2.46912]).addTo(parisMap);;
      //---------------------------------------------------------------------------------------------------------------------
      if (accessData[basemap]===undefined){ // No apikey or access token needed
        L.tileLayer(data["url"],data).addTo(parisMap);
        tbl1 = document.createElement("table");
        tbl1.className = "table-container";

        for (let i = 0; i < nbOfRows; i++) {
          const tr1 = tbl1.insertRow();
          for (let j = 0; j < 2; j++) {
            if (i === nbOfRows-2 && j === 2) {
              break;
            } 
            else {
             const td1 = tr1.insertCell();
             if(j==0){// First column of the table : the one with the keys
               td1.appendChild(document.createTextNode(key[i]));
               td1.className="key-cell";
              }
            else {// Second column of the table : the one with the values of the metadata
              td1.className="val-cell"
              td1.appendChild(document.createTextNode(val[i]));
            }
          }
        }
      }
      body.appendChild(tbl1);
    }
    //---------------------------------------------------------------------------------------------------------------------
	    else{ // You need to give an apikey or an access token and possibibly an ID code to display the map
        dict=accessData[basemap];
        var keyString=dict["keyString"]; 
        var idString=dict["idString"]
        tbl2 = document.createElement("table");
        tbl2.className = "table-container";
        for (let i = 0; i < nbOfRows; i++) {
            const tr2 = tbl2.insertRow();
            for (let j = 0; j < 2; j++) {
              if (i === nbOfRows-2 && j === 2) {
                break;
              } 
              else {
              const td2 = tr2.insertCell();
              if(j==0){// First column of the table : the one with the keys
                td2.appendChild(document.createTextNode(key[i]));
                td2.className="key-cell";
              }
              else {// Second column of the table : the one with the values of the metadata
                td2.className="val-cell"
                //*******************************************************************************
                //*******************************************************************************
                //*******************************************************************************
                if(key[i]===keyString&& key[i-1]!==idString) { // consider separately HERE and HERE.v3 with an app_id code and and app_code 
                  //create an input and a button with onclick function
                  var keyInput = document.createElement("input");
                  keyInput.type="text";
                  keyInput.value="Enter your APIkey please";
                  keyInput.className='key-container';
                  td2.append(keyInput);  
                  var validationButton = document.createElement("button");
                  validationButton.className="button-container";
                  td2.append(validationButton); 
                  validationButton.innerHTML = "validate";
                  validationButton.onclick=get_keyCode;
                  function get_keyCode() {
                    val[i]=keyInput.value;
                    data[keyString]=keyInput.value;
                    L.tileLayer(data["url"],data).addTo(parisMap);
                  }
                }

              else if(key[i]===idString && key[i+1]===keyString) { // consider separately the case where key is the apikey or access token 
                //create an input and a button with onclick function
                  var idInput = document.createElement("input");
                  idInput.type="text";
                  idInput.value="Enter your IDkey please";
                  idInput.className='key-container';
                  td2.append(idInput);  
                  var validationButton = document.createElement("button");
                  validationButton.className="button-container";
                  td2.append(validationButton); 
                  validationButton.innerHTML = "validate";
                  validationButton.onclick=get_bothCodes;
                  function get_bothCodes() {
                      val[i]=idInput.value;
                      data[idString]=idInput.value;
                      var keyInput = document.createElement("input");
                      keyInput.type="text";
                      keyInput.value="Enter your APIkey please";
                      keyInput.className='key-container';
                      td2.append(keyInput);  
                      var validationButton = document.createElement("button");
                      validationButton.className="button-container";
                      td2.append(validationButton); 
                      validationButton.innerHTML = "validate";
                      validationButton.onclick=get_keyCode;
                      function get_keyCode() {
                        val[i+1]=keyInput.value;
                        data[keyString]=keyInput.value;
                        L.tileLayer(data["url"],data).addTo(parisMap);
                      }
                    }
                  }
               

                else{
                  td2.appendChild(document.createTextNode(val[i]));
                }
              }
            }
          } 
        }  
      body.appendChild(tbl2);
      }
    }
  catch {
  }
}

getJSON("https://raw.githubusercontent.com/geopandas/xyzservices/main/provider_sources/leaflet-providers-parsed.json", (err, data) => {
    var dataList=[]   
      for([key,val] of Object.entries(data)) { 
	      if (val["url"]===undefined){// check if url is a key of the json object, if not go one level deeper and define the val as the new object
		      newData=val; // need 

		      for([newKey,newVal] of Object.entries(newData)) {
			      if (newVal["bounds"]!==undefined){
              newVal["bounds"]=undefined;		
            }
		      dataList.push(newVal);	
		      }
	      }
		
	      else{
  		    dataList.push(val);
	      }
      }
      const section1 = document.createElement("section");
      section1.className = "top-page";
      document.body.append(section1); 
      const header=document.createElement("header")
      header.className = "header";
      document.body.append(header); 
      const div1=document.createElement("div")
      div1.className = "landing-page";
      document.body.append(div1); 
      const h1 = document.createElement("h1");
      h1.className = "big-title";
      const textNode1 = document.createTextNode("Welcome to Leaflet's catalog");
      h1.appendChild(textNode1);
      document.body.append(h1);

      for (let ii = 1; ii < dataList.length-2; ii++){
          data=dataList[ii];
          const div2 = document.createElement("div");
          div2.className = "thumbnail";
          
          initMapTitle(data);
          initMap(data,accessData);
          document.body.append(div2); 
        }
  })

</script>
</body>
</html>
